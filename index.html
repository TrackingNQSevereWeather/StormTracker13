<!DOCTYPE html>
<html>
<head>
  <title>StormTracker 13 | TrackingNQSevereWeather Real Time Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-timedimension/dist/leaflet.timedimension.control.min.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-timedimension/dist/leaflet.timedimension.min.js"></script>

  <script>
    // Create map with time slider and dark mode
    const map = L.map("map", {
      center: [39.5, -98.35], // Center USA
      zoom: 5,
      timeDimension: true,
      timeDimensionControl: true,
      timeDimensionOptions: {
        timeInterval: "PT3H/PT0H",
        period: "PT5M"
      }
    });

    // Dark mode basemap (CartoDB)
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
      subdomains: "abcd",
      maxZoom: 19
    }).addTo(map);

    // Radar Reflectivity Layer (Iowa State N0Q)
    const radarLayer = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::N0Q::USCOMP/{z}/{x}/{y}.png", {
      attribution: "Iowa State Mesonet",
      transparent: true
    }).addTo(map);

    // Load NWS Warnings
    async function loadWarnings() {
      try {
        const res = await fetch("https://api.weather.gov/alerts/active");
        const data = await res.json();

        const warningsLayer = L.geoJSON(data, {
          style: (feature) => {
            const type = feature.properties.event;
            let color = "#FF0000";
            if (type.includes("Tornado")) color = "#FF0000";
            else if (type.includes("Severe Thunderstorm")) color = "#FFA500";
            else if (type.includes("Flash Flood")) color = "#008000";
            else if (type.includes("Flood")) color = "#00FF00";
            else if (type.includes("Winter Storm")) color = "#1E90FF";
            else if (type.includes("Hurricane")) color = "#800000";
            else if (type.includes("Marine")) color = "#9370DB";

            return {
              color: color,
              weight: 2,
              fillOpacity: 0.3
            };
          },
          onEachFeature: (feature, layer) => {
            layer.bindPopup(`<strong>${feature.properties.event}</strong><br>${feature.properties.headline}`);
          }
        });

        warningsLayer.addTo(map);

        // Store for refresh
        map._warningsLayer = warningsLayer;
      } catch (e) {
        console.error("Failed to load warnings", e);
      }
    }

    // Initial load
    loadWarnings();

    // Auto-refresh every 5 minutes
    setInterval(() => {
      radarLayer.setUrl("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::N0Q::USCOMP/{z}/{x}/{y}.png?" + new Date().getTime());

      if (map._warningsLayer) {
        map.removeLayer(map._warningsLayer);
      }
      loadWarnings();
    }, 5 * 60 * 1000);
  </script>
</body>
</html>

