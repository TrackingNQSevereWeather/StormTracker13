<!DOCTYPE html>
<html>
<head>
  <title>StormTracker 13 | TrackingNQSevereWeather Real Time Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      width: 100%;
      height: 100vh;
    }
    .leaflet-control-layers {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-timedimension/dist/leaflet.timedimension.min.js"></script>
  <script src="https://unpkg.com/leaflet-velocity/dist/leaflet-velocity.min.js"></script>

  <script>
    const map = L.map("map", {
      center: [39.5, -98.35], // Center USA
      zoom: 5,
      timeDimension: true,
      timeDimensionControl: true,
      timeDimensionOptions: {
        timeInterval: "PT3H/PT0H",
        period: "PT5M"
      }
    });

    // Base layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // Radar layer (Reflectivity from Iowa State)
    const radarLayer = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::N0Q::USCOMP/{z}/{x}/{y}.png", {
      attribution: "Iowa State Mesonet",
      transparent: true
    }).addTo(map);

    // Satellite placeholder
    const satelliteLayer = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/goes16-vis-usa/{z}/{x}/{y}.png", {
      attribution: "Satellite via Iowa State",
      transparent: true
    });

    // Simulated lightning layer
    const lightningLayer = L.tileLayer("https://tile.openweathermap.org/map/lightning_new/{z}/{x}/{y}.png?appid=YOUR_API_KEY", {
      attribution: "Lightning data © OpenWeather",
      transparent: true
    });

    // Weather Warnings from NWS
    async function loadWarnings() {
      const res = await fetch("https://api.weather.gov/alerts/active");
      const data = await res.json();

      const warningsLayer = L.geoJSON(data, {
        style: (feature) => {
          const type = feature.properties.event;
          let color = "#FF0000";
          if (type.includes("Tornado")) color = "#FF0000";
          else if (type.includes("Severe Thunderstorm")) color = "#FFA500";
          else if (type.includes("Flash Flood")) color = "#006400";
          else if (type.includes("Flood")) color = "#00FF00";
          else if (type.includes("Marine")) color = "#800080";
          else if (type.includes("Winter Storm")) color = "#1E90FF";
          else if (type.includes("Hurricane")) color = "#8B0000";

          return {
            color: color,
            weight: 2,
            fillOpacity: 0.3
          };
        },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(`<strong>${feature.properties.event}</strong><br>${feature.properties.headline}`);
        }
      });

      warningsLayer.addTo(map);
    }
    loadWarnings();

    // Layer control
    const baseLayers = {
      "OpenStreetMap": map
    };

    const overlays = {
      "Radar (Reflectivity)": radarLayer,
      "Satellite": satelliteLayer,
      "Lightning": lightningLayer
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    // Auto-refresh radar layer every 5 minutes
    setInterval(() => {
      radarLayer.setUrl("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::N0Q::USCOMP/{z}/{x}/{y}.png?" + new Date().getTime());
      loadWarnings(); // refresh warnings too
    }, 5 * 60 * 1000);
  </script>
</body>
</html>

